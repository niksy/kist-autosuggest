/*! kist-autosuggest 0.1.7 - Simple autosuggest plugin. | Author: Ivan NikoliÄ‡, 2014 | License: MIT */
!function(a,b,c){function d(){"string"===a.type(this.options.source)&&(this.options.source=a.extend({},this.defaults.source,{url:this.options.source})),this.options.classes={},this.options.classesNs={},a.each(p.classes,a.proxy(function(b,c){var d=a.trim(this.options.namespace),e=p.ns.css,f=e+c,g=f;/^is[A-Z]/.test(b)?f=g=c:d!==e&&""!==d&&(g=d+c,f=e+c+" "+g),this.options.classesNs[b]=g,this.options.classes[b]=f},this))}function e(a){return this.map.url&&(a.url=a[this.map.url]),a}function f(a,b){return b?b.replace(new RegExp(a,"i"),'<mark class="'+this.options.classes.match+'">$&</mark>'):""}function g(b,c){b=e.call(this.options,b);var d,g=f.call(this,this.getInputVal(),b[this.options.map.label]);return g?(d=a("<li />",{id:p.ns.css+p.classes.item+"-"+this.instance.id+"-"+c,"class":this.options.classes.item,role:"option"}),d.data(p.ns.dom+"-data",b).append(a(this.options.templates.item.call(this.element,b))).find(this.options.selectors.toggler).addClass(this.options.classes.toggler),d.find(this.options.selectors.value).addClass(this.options.classes.value).html(g),h.call(this,"items",d),d):void 0}function h(b,c){return(!this.dom[b]||this.dom[b]&&0===c.length)&&(this.dom[b]=a(),0===c.length)?this.dom[b]:(this.dom[b]=this.dom[b].add(c),this.dom[b])}function i(b){return this.dom[b]||a()}function j(b){var c=b.which,d=a(b.target);(c==t.escape&&d.is(this.dom.el)||c>=t.mouseLeft&&c<=t.mouseRight&&0===d.closest(this.dom.results).length&&!d.is(this.dom.el))&&this.hideResults()}function k(b,c){var d=c.which;return this.setInputVal(a(c.target).val(),!0),-1!==a.inArray(d,v)||this.getInputVal().length<this.options.minLength?void(-1===a.inArray(d,u)&&this.hideResults()):void b.call(this,this.getInputVal())}function l(a){var b=a.which;switch(b){case t.up:case t.down:this.dom.results.hasClass(this.options.classes.isOpened)||this.showResults(),this.navigate(b===t.down?"down":"up");break;case t.enter:n.call(this)}}function m(b){var c=a(b.target).closest("."+this.options.classesNs.item);this.setCurrentItem(c),this.setInputVal(c.find(this.options.selectors.value).text()),n.call(this),this.options.preventSubmit||this.dom.form.trigger("submit")}function n(){p.cb.call(this,"select",[this.getCurrentItem(),this.getItemData(this.getCurrentItem())]),this.hideResults()}function o(b,c){this.element=b,this.options=a.extend(!0,{},this.defaults,c),d.call(this,c),s.setup.call(this),q.setup.call(this),q.setupWrapper.call(this),q.setupAfter.call(this),r.setup.call(this)}var p={name:"autosuggest",ns:{css:"kist-Autosuggest",event:".kist.autosuggest",dom:"kist-autosuggest"},error:function(a){throw new Error(p.name+": "+a)}};p.classes={wrapper:"",results:"-results",input:"-input",list:"-list",item:"-item",toggler:"-toggler",value:"-value",match:"-match",preloader:"-preloader",group:"-group",groupTitle:"-group-title",isSelected:"is-selected",isOpened:"is-opened",isActive:"is-active"},p.publicMethods=["destroy"],p.cb=function(a,b){this.options[a]&&this.options[a].apply(this.element,b),this.dom.el.trigger((p.name+a).toLowerCase(),b)};var q={common:{doc:a(c)},setup:function(){this.dom=this.dom||{},this.dom.el=a(this.element),this.dom.form=this.dom.el.closest("form"),this.dom.form=this.dom.form.length?this.dom.form:a()},setupWrapper:function(){this.dom.wrapper=a("<div />",{"class":this.options.classes.wrapper}),this.dom.preloader=a("<div />"),this.dom.preloader.addClass(this.options.classes.preloader).removeClass(this.options.classes.isActive),this.dom.wrapper.insertBefore(this.dom.el).append(this.dom.el,this.dom.preloader)},setupAfter:function(){this.options.source.url||0===this.dom.form.length||(this.options.source.url=this.dom.form.attr("action")),this.dom.results=a("<div />"),this.dom.results.attr({id:p.ns.css+p.classes.results+"-"+this.instance.id,role:"listbox","aria-expanded":!1}).addClass(this.options.classes.results).removeClass(this.options.classes.isOpened).appendTo(this.dom.wrapper),this.dom.el.addClass(this.options.classes.input).attr({role:"combobox","aria-autocomplete":"list","aria-owns":p.ns.css+p.classes.results+"-"+this.instance.id,"aria-activedescendant":"",autocomplete:"off",autocorrect:"off"}),p.cb.call(this,"create",[this.dom.el])},destroy:function(){this.dom.el.removeClass(this.options.classes.input).removeAttr("role aria-autocomplete aria-owns aria-activedescendant autocomplete autocorrect").insertBefore(this.dom.wrapper),this.dom.wrapper.remove()}},r={setup:function(){this.dom.el.on("keyup"+this.instance.ens,"debounce"in a?a.debounce(300,a.proxy(k,this,this.getData)):a.proxy(k,this,this.getData)).on("keydown"+this.instance.ens,a.proxy(l,this)).on("focus"+this.instance.ens,a.proxy(this.showResults,this)).on("focus"+this.instance.ens,a.proxy(function(){p.cb.call(this,"focus",[this.dom.el])},this)).on("blur"+this.instance.ens,a.proxy(function(){p.cb.call(this,"blur",[this.dom.el])},this)),this.dom.wrapper.on("click"+this.instance.ens,"."+this.options.classesNs.toggler,a.proxy(m,this)),q.common.doc.on("click"+this.instance.ens,a.proxy(j,this)).on("keydown"+this.instance.ens,a.proxy(j,this)),this.options.preventSubmit&&this.dom.form.on("submit"+this.instance.ens,function(a){a.preventDefault()})},destroy:function(){q.common.doc.off(this.instance.ens),this.dom.el.off(this.instance.ens),this.dom.wrapper.off(this.instance.ens),this.dom.form.off(this.instance.ens)}},s={id:0,setup:function(){this.instance=this.instance||{},this.instance.id=s.id++,this.instance.ens=p.ns.event+"."+this.instance.id},destroy:function(){delete a.data(this.element)[p.name]}},t={enter:13,escape:27,up:38,down:40,mouseLeft:1,mouseRight:3},u=[16,17,18,20,37,t.up,39,t.down,91,93],v=[9,t.enter,t.escape].concat(u);a.extend(o.prototype,{setCacheData:function(a){this.cacheDataExists(this.getInputVal())||(this.cache[this.getInputVal()]=a)},getCacheData:function(a){return this.cacheDataExists(a)?this.cache[a]:void 0},cacheDataExists:function(a){return this.cache.hasOwnProperty(a)},showResults:function(){0!==i.call(this,"selectableItems").length&&(this.dom.results.hasClass(this.options.classes.isOpened)||p.cb.call(this,"open",[this.dom.el]),this.dom.results.attr("aria-expanded",!0).addClass(this.options.classes.isOpened),this.dom.wrapper.addClass(this.options.classes.isOpened))},hideResults:function(){this.dom.results.hasClass(this.options.classes.isOpened)&&p.cb.call(this,"close",[this.dom.el]),this.dom.results.attr("aria-expanded",!1).removeClass(this.options.classes.isOpened),this.dom.wrapper.removeClass(this.options.classes.isOpened)},createGroup:function(b){var c,d=a();return a.each(b,a.proxy(function(b,e){c=a("<div />",{"class":this.options.classes.group}),c.append(a(this.options.templates.groupTitle.call(this.element,e)),this.createList(e[this.options.map.groupItems])).find(this.options.selectors.groupTitle).addClass(this.options.classes.groupTitle),d=d.add(c)},this)),d},createList:function(b){var c=a("<ul />",{"class":this.options.classes.list});return this.createItems(b),c.append(i.call(this,"items")),h.call(this,"selectableItems",i.call(this,"items")),h.call(this,"items",a()),c},createItems:function(b){a.each(b,a.proxy(function(a,b){return a==this.options.maxItems?!1:void g.call(this,b,a)},this))},navigate:function(a){var b=this.getCurrentItem(),c=i.call(this,"selectableItems");0!==c.length&&(b=b.length?b:c.filter("."+this.options.classes.isSelected),0!==b.length?(b=c.eq("down"==a?++this.position:--this.position),(this.position>=c.length||this.position<0)&&(this.position>=c.length?this.position=0:this.position<0&&(this.position=c.length-1),b=c.eq(this.position))):b=c["down"==a?"first":"last"](),p.cb.call(this,"move",[b,this.getItemData(b)]),this.setCurrentItem(b),this.setInputVal(b.find(this.options.selectors.value).text()))},getItemData:function(a){return a.data(p.ns.dom+"-data")||{}},setCurrentItem:function(a){return this.dom.currentItem=a,0!==a.length&&(this.dom.prevItem&&this.dom.prevItem.removeClass(this.options.classes.isSelected),this.dom.currentItem.addClass(this.options.classes.isSelected),this.dom.el.attr("aria-activedescendant",this.dom.currentItem.attr("id"))),this.dom.prevItem=this.dom.currentItem,this.dom.currentItem},getCurrentItem:function(){return this.dom.currentItem||a()},setInputVal:function(a,b){this.val=a,b||this.dom.el.val(a)},getInputVal:function(){return this.val},getData:function(b){var c={};return p.cb.call(this,"search",[b]),this.cacheDataExists(b)?void this.showData(this.getCacheData(b)):(c[this.options.map.query]=b,this.dom.preloader.addClass(this.options.classes.isActive),void a.ajax(a.extend(!0,{},this.options.source,{data:c})).done(a.proxy(this.showData,this)))},showData:function(a){return p.cb.call(this,"response",[a]),this.dom.preloader.removeClass(this.options.classes.isActive),!a||a&&!a.length?void this.hideResults():(this.setCacheData(a),this.cleanup(),this["simple"==this.options.responseType?"createList":"createGroup"](a).appendTo(this.dom.results),void this.showResults())},cleanup:function(){this.dom.results.empty(),this.setCurrentItem(a()),h.call(this,"selectableItems",a()),this.position=0},destroy:function(){q.destroy.call(this),r.destroy.call(this),s.destroy.call(this)},cache:{},val:"",position:0,defaults:{source:{url:"",type:"get",dataType:"json"},responseType:"simple",minLength:2,maxItems:10,preventSubmit:!0,map:{url:"",query:"value",label:"value",groupItems:"items"},selectors:{toggler:"button, a",value:"button span, a span",groupTitle:"h2"},templates:{item:function(a){var b='button type="button"',c="button";return a.url&&(b='a href="'+a.url+'"',c="a"),"<"+b+"><span>"+a.value+"</span></"+c+">"},groupTitle:function(a){return"<h2>"+a.group+" </h2>"}},namespace:p.ns.css,create:a.noop,open:a.noop,close:a.noop,focus:a.noop,blur:a.noop,search:a.noop,response:a.noop,move:a.noop,select:a.noop}}),a.kist=a.kist||{},a.kist[p.name]={defaults:o.prototype.defaults},a.fn[p.name]=function(b){return"string"==typeof b&&-1!==a.inArray(b,p.publicMethods)?this.each(function(){var c=a.data(this,p.name);c&&c[b]()}):(b="object"==typeof b?b:{},this.each(function(){a.data(this,p.name)||a.data(this,p.name,new o(this,b))}))}}(jQuery,window,document);