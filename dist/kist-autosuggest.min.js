/*! kist-autosuggest 0.0.0 - Simple autosuggest plugin. | Author: Ivan NikoliÄ‡, 2014 | License: MIT */
!function(a,b,c){function d(b){switch(b=b||{},a.type(b.source)){case"string":b.source=a.extend({},this.defaults.source,{url:b.source})}return b}function e(a){return this.map.url&&(a.url=a[this.map.url]),a}function f(a,b){return b?b.replace(new RegExp(a,"i"),'<mark class="'+o.classes.match+'">$&</mark>'):""}function g(b){b=e.call(this.options,b);var c,d=f.call(this,this.getInputVal(),b[this.options.map.label]);return d?(c=a("<li />",{"class":o.classes.item}),c.data(o.ns.dom+"-data",b).append(a(this.options.templates.item.call(null,b))).find(this.options.selectors.toggler).addClass(o.classes.toggler),c.find(this.options.selectors.value).addClass(o.classes.value).html(d),h.call(this,"items",c),c):void 0}function h(b,c){return(!this.dom[b]||this.dom[b]&&0===c.length)&&(this.dom[b]=a(),0===c.length)?this.dom[b]:(this.dom[b]=this.dom[b].add(c),this.dom[b])}function i(b){return this.dom[b]||a()}function j(b){var c=b.which,d=a(b.target);(c==s.escape&&d.is(this.dom.el)||c>=s.mouseLeft&&c<=s.mouseRight&&0===d.closest(this.dom.results).length&&!d.is(this.dom.el))&&this.hideResults()}function k(b,c){var d=c.which;return this.setInputVal(a(c.target).val(),!0),-1!==a.inArray(d,u)||this.getInputVal().length<this.options.minLength?void(-1===a.inArray(d,t)&&this.hideResults()):void b.call(this,this.getInputVal())}function l(a){var b=a.which;switch(b){case s.up:case s.down:this.dom.results.hasClass(o.classes.isHidden)&&this.showResults(),this.navigate(b===s.down?"down":"up");break;case s.enter:this.options.select.call(null,this.getCurrentItem(),this.getCurrentItem().data(o.ns.dom+"-data"))}}function m(b){var c=a(b.target).closest("."+o.classes.item);this.setCurrentItem(c),this.setInputVal(c.find(this.options.selectors.value).text()),this.hideResults(),this.options.select.call(null,this.getCurrentItem(),this.getCurrentItem().data(o.ns.dom+"-data")),this.options.preventSubmit||this.dom.form.trigger("submit")}function n(b,c){this.element=b,this.options=a.extend(!0,{},this.defaults,d.call(this,c)),r.setup.call(this),p.setup.call(this),p.setupWrapper.call(this),q.setup.call(this),p.setupAfter.call(this)}var o={name:"autosuggest",ns:{css:"kist-Autosuggest",event:".kist.autosuggest",dom:"kist-autosuggest"},error:function(a){throw new Error(o.name+": "+a)}};o.classes={wrapper:o.ns.css,results:o.ns.css+"-results",input:o.ns.css+"-input",form:o.ns.css+"-form",list:o.ns.css+"-list",item:o.ns.css+"-item",toggler:o.ns.css+"-toggler",value:o.ns.css+"-value",match:o.ns.css+"-match",preloader:o.ns.css+"-preloader",group:o.ns.css+"-group",groupTitle:o.ns.css+"-group-title",isHidden:"is-hidden",isSelected:"is-selected",isOpened:"is-opened"},o.publicMethods=["destroy"];var p={common:{document:a(c)},setup:function(){this.dom=this.dom||{},this.dom.el=a(this.element),this.dom.form=this.dom.el.closest("form")},setupWrapper:function(){this.dom.wrapper=a("<div />",{"class":o.classes.wrapper}),this.dom.preloader=a("<div />"),this.dom.preloader.addClass(o.classes.preloader).addClass(o.classes.isHidden),this.dom.wrapper.insertBefore(this.dom.el).append(this.dom.el,this.dom.preloader)},setupAfter:function(){this.options.source.url||0===this.dom.form.length||(this.options.source.url=this.dom.form.attr("action")),this.dom.results=a("<div />"),this.dom.results.addClass(o.classes.results).addClass(o.classes.isHidden).appendTo(this.dom.wrapper),this.dom.el.addClass(o.classes.input).attr({autocomplete:"off",autocorrect:"off"}),this.dom.form.addClass(o.classes.form)},destroy:function(){this.dom.el.removeClass(o.classes.input).removeAttr("autocomplete autocorrect").insertBefore(this.dom.wrapper),this.dom.form.removeClass(o.classes.form).removeClass(o.classes.isOpened),this.dom.wrapper.remove()}},q={setup:function(){this.dom.el.on("keyup"+this.instance.ens,"debounce"in a?a.debounce(300,a.proxy(k,this,this.getData)):a.proxy(k,this,this.getData)).on("keydown"+this.instance.ens,a.proxy(l,this)).on("focus"+this.instance.ens,a.proxy(this.showResults,this)),this.dom.wrapper.on("click"+this.instance.ens,"."+o.classes.toggler,a.proxy(m,this)),p.common.document.on("click"+this.instance.ens,a.proxy(j,this)).on("keydown"+this.instance.ens,a.proxy(j,this)),this.options.preventSubmit&&this.dom.form.on("submit"+this.instance.ens,function(a){a.preventDefault()})},destroy:function(){p.common.document.off(this.instance.ens),this.dom.el.off(this.instance.ens),this.dom.wrapper.off(this.instance.ens),this.dom.form.off(this.instance.ens)}},r={id:0,setup:function(){this.instance=this.instance||{},this.instance.id=r.id++,this.instance.ens=o.ns.event+"."+this.instance.id},destroy:function(){delete a.data(this.element)[o.name]}},s={enter:13,escape:27,up:38,down:40,mouseLeft:1,mouseRight:3},t=[16,17,18,20,37,s.up,39,s.down,91,93],u=[9,s.enter,s.escape].concat(t);a.extend(n.prototype,{cache:{},inputVal:"",position:0,setCacheData:function(a){this.cacheDataExists(this.getInputVal())||(this.cache[this.getInputVal()]=a)},getCacheData:function(a){return this.cacheDataExists(a)?this.cache[a]:void 0},cacheDataExists:function(a){return this.cache.hasOwnProperty(a)},showResults:function(){0!==i.call(this,"selectableItems").length&&(this.dom.results.removeClass(o.classes.isHidden),this.dom.form.addClass(o.classes.isOpened))},hideResults:function(){this.dom.results.addClass(o.classes.isHidden),this.dom.form.removeClass(o.classes.isOpened)},createGroup:function(b){var c,d=a();return a.each(b,a.proxy(function(b,e){c=a("<div />",{"class":o.classes.group}),c.append(a(this.options.templates.groupTitle.call(null,e)),this.createList(e[this.options.map.groupItems])).find(this.options.selectors.groupTitle).addClass(o.classes.groupTitle),d=d.add(c)},this)),d},createList:function(b){var c=a("<ul />",{"class":o.classes.list});return this.createItems(b),c.append(i.call(this,"items")),h.call(this,"selectableItems",i.call(this,"items")),h.call(this,"items",a()),c},createItems:function(b){a.each(b,a.proxy(function(a,b){return a==this.options.maxItems?!1:void g.call(this,b)},this))},navigate:function(a){var b=this.getCurrentItem(),c=i.call(this,"selectableItems");0!==c.length&&(b=b.length?b:c.filter("."+o.classes.isSelected),0!==b.length?(b=c.eq("down"==a?++this.position:--this.position),(this.position>=c.length||this.position<0)&&(this.position>=c.length?this.position=0:this.position<0&&(this.position=c.length-1),b=c.eq(this.position))):b=c["down"==a?"first":"last"](),this.setCurrentItem(b),this.setInputVal(b.find(this.options.selectors.value).text()))},setCurrentItem:function(a){return this.dom.currentItem=a,0!==a.length&&(this.dom.prevItem&&this.dom.prevItem.removeClass(o.classes.isSelected),this.dom.currentItem.addClass(o.classes.isSelected)),this.dom.prevItem=this.dom.currentItem,this.dom.currentItem},getCurrentItem:function(){return this.dom.currentItem||a()},setInputVal:function(a,b){this.inputVal=a,b||this.dom.el.val(a)},getInputVal:function(){return this.inputVal},getData:function(b){var c={};return this.cacheDataExists(b)?void this.showData(this.getCacheData(b)):(c[this.options.map.query]=b,this.dom.preloader.removeClass(o.classes.isHidden),void a.ajax(a.extend(!0,{},this.options.source,{data:c})).done(a.proxy(this.showData,this)))},showData:function(a){return this.dom.preloader.addClass(o.classes.isHidden),!a||a&&!a.length?void this.hideResults():(this.setCacheData(a),this.cleanup(),this["simple"==this.options.response?"createList":"createGroup"](a).appendTo(this.dom.results),void this.showResults())},cleanup:function(){this.dom.results.empty(),this.setCurrentItem(a()),h.call(this,"selectableItems",a()),this.position=0},destroy:function(){p.destroy.call(this),q.destroy.call(this),r.destroy.call(this)},defaults:{source:{url:"",type:"get",dataType:"json"},response:"simple",minLength:2,maxItems:10,preventSubmit:!0,map:{url:"",query:"value",label:"value",groupItems:"items"},selectors:{toggler:"button, a",value:"button span, a span",groupTitle:"h2"},templates:{item:function(a){var b='button type="button"',c="button";return a.url&&(b='a href="'+a.url+'"',c="a"),"<"+b+"><span>"+a.value+"</span></"+c+">"},groupTitle:function(a){return"<h2>"+a.group+" </h2>"}},select:function(){}}}),a.kist=a.kist||{},a.kist[o.name]={defaults:n.prototype.defaults},a.fn[o.name]=function(b){return this.each("string"==typeof b&&-1!==a.inArray(b,o.publicMethods)?function(){var c=a.data(this,o.name);c&&c[b]()}:function(){a.data(this,o.name)||a.data(this,o.name,new n(this,b))})}}(jQuery,window,document);